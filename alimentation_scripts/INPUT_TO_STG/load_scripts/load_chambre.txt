DEFINE JOB import_file_CHAMBRE
DESCRIPTION 'Load CHAMBRE_XXXXXXXX.tpt in CHAMBRE table'
(
  /*
    Define the schema of the data in the TPT file
  */
  DEFINE SCHEMA SCHEMA_INPUT_CHAMBRE
    (
      in_no_chambre INTEGER,
      in_nom_chambre VARCHAR(20),
      in_no_etage BYTEINT,
      in_nom_batiment VARCHAR(20),
      in_type_chambre VARCHAR(20),
      in_prix_jour SMALLINT,
      in_dt_creation DATE
    );

  /*
    Define the file reader operator to read the TPT file
  */
  DEFINE OPERATOR $FILE_READER
    TYPE DATACONNECTOR PRODUCER
    SCHEMA *
    ATTRIBUTES
      (
        VARCHAR FileName = '<path_to_your_tpt_file>',
        VARCHAR Format = 'TPT',
        VARCHAR OpenMode = 'Read'
      );

  /*
    Define the DDL operator for executing DDL statements
  */
  DEFINE OPERATOR $DDL
    TYPE DDL
    ATTRIBUTES
      (
        VARCHAR TdpId = '<your_tdpid>',
        VARCHAR UserName = '<your_username>',
        VARCHAR UserPassword = '<your_password>',
        VARCHAR ErrorList = '3807'
      );

  /*
    Define the load operator for loading data into the target table
  */
  DEFINE OPERATOR $LOAD
    TYPE LOAD
    SCHEMA *
    ATTRIBUTES
      (
        VARCHAR TdpId = '<your_tdpid>',
        VARCHAR UserName = '<your_username>',
        VARCHAR UserPassword = '<your_password>',
        VARCHAR LogTable = '<your_log_table>',
        VARCHAR ErrorTable1 = '<your_error_table_1>',
        VARCHAR ErrorTable2 = '<your_error_table_2>',
        VARCHAR ErrorTable3 = '<your_error_table_3>'
      );

  /*
    In the first step, we are sending statements to remove old tables
    and create a new one.
    This step replies on configuration stored in `$DDL` operator
  */
  STEP st_Setup_Tables
  (
    APPLY
      ('DROP TABLE ' || @LoadTargetTable || ';'),
      ('CREATE TABLE ' || @LoadTargetTable || ' (
          NO_CHAMBRE INTEGER NOT NULL PRIMARY KEY,
          NOM_CHAMBRE VARCHAR(20) NOT NULL,
          NO_ETAGE BYTEINT,
          NOM_BATIMENT VARCHAR(20),
          TYPE_CHAMBRE VARCHAR(20),
          PRIX_JOUR SMALLINT NOT NULL,
          DT_CREATION DATE NOT NULL
        );')
    TO OPERATOR ($DDL);
  );

  /*
    Finally, in this step we read the data from the file operator
    and send it to the load operator.
  */
  STEP st_Load_File
  (
    APPLY
      ('INSERT INTO ' || @LoadTargetTable || ' (
          NO_CHAMBRE,
          NOM_CHAMBRE,
          NO_ETAGE,
          NOM_BATIMENT,
          TYPE_CHAMBRE,
          PRIX_JOUR,
          DT_CREATION
      ) VALUES (
          :in_no_chambre,
          :in_nom_chambre,
          :in_no_etage,
          :in_nom_batiment,
          :in_type_chambre,
          :in_prix_jour,
          :in_dt_creation
      );')
    TO OPERATOR ($LOAD)
    SELECT * FROM OPERATOR($FILE_READER(SCHEMA_INPUT_CHAMBRE));
  );
);